---
import type { CollectionEntry } from "astro:content";
import { createLocalizedUrl } from "@lib/i18n";
import {
  getCollectionSlug,
  getBlogEntryLanguage,
  getBlogEntryCategory,
  getTilCollectionSlug,
  getTilEntryLanguage,
  getTilEntryCategory
} from "@lib/slug-utils";
import { formatDateKorean } from "@lib/utils";
import {
  getTilCategoryName,
  TIL_CATEGORIES,
  BLOG_CATEGORIES,
  type TilCategoryKey,
  type BlogCategoryKey
} from "@lib/categories";

type Props = {
  entry: CollectionEntry<"blog"> | CollectionEntry<"til">;
}

const { entry } = Astro.props;

// Dynamically determine which helper functions to use based on collection type
const slug = entry.collection === "blog"
  ? getCollectionSlug(entry as CollectionEntry<"blog">)
  : getTilCollectionSlug(entry as CollectionEntry<"til">);

const entryLanguage = entry.collection === "blog"
  ? getBlogEntryLanguage(entry as CollectionEntry<"blog">)
  : getTilEntryLanguage(entry as CollectionEntry<"til">);

const categoryKey = entry.collection === "blog"
  ? getBlogEntryCategory(entry as CollectionEntry<"blog">)
  : getTilEntryCategory(entry as CollectionEntry<"til">);

// Get localized category name with fallback to key
const getCategoryDisplayName = () => {
  // Check TIL_CATEGORIES first (shared between blog and til)
  if (categoryKey in TIL_CATEGORIES) {
    return getTilCategoryName(categoryKey as TilCategoryKey, entryLanguage);
  }
  // Check BLOG_CATEGORIES for blog-specific categories
  if (entry.collection === "blog" && categoryKey in BLOG_CATEGORIES) {
    return BLOG_CATEGORIES[categoryKey as BlogCategoryKey][entryLanguage];
  }
  return categoryKey; // fallback to raw key
};

const categoryName = getCategoryDisplayName();
const formattedDate = formatDateKorean(entry.data.date);

const entryHref = createLocalizedUrl(`${entry.collection}/${slug}`, entryLanguage);
---

<a href={entryHref} class="relative group flex flex-nowrap py-3 px-4 pr-10 rounded-lg border border-black/15 dark:border-white/20 hover:bg-black/5 dark:hover:bg-white/5 hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out">
  <div class="flex flex-col flex-1 truncate">
    <div class="font-semibold">
      {entry.data.title}
    </div>
    <div class="text-xs opacity-60">
      [{categoryName}] Â· {formattedDate}
    </div>
    <div class="text-sm">
      {entry.data.description}
    </div>
  </div>
  <svg 
    xmlns="http://www.w3.org/2000/svg" 
    viewBox="0 0 24 24"
    class="absolute top-1/2 right-2 -translate-y-1/2 size-5 stroke-2 fill-none stroke-current">
    <line x1="5" y1="12" x2="19" y2="12" class="translate-x-3 group-hover:translate-x-0 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-in-out" />
    <polyline points="12 5 19 12 12 19" class="-translate-x-1 group-hover:translate-x-0 transition-transform duration-300 ease-in-out" />
  </svg>
</a>
