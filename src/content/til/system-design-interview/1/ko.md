---
title: "1장: 사용자 수에 따른 규모 확장성"
description: "시스템 설계에서 가장 기본적이면서도 중요한 개념인 규모 확장성에 대해 살펴봅니다. 수직적 확장과 수평적 확장의 차이점, 로드 밸런서의 역할, 그리고 무상태 웹 계층의 필요성에 대해 알아봅니다."
date: "2023-06-01"
draft: false
---

## 서버의 확장

### 수직적 확장
- 서버에 고사양 자원을 추가하는 방식을 뜻한다.
- 명확한 한계가 있고 장애 복구 방안, 장애 시 대응 방안을 마련하기 어렵다.

### 수평적 확장
- 서버 대수를 늘리는 방식을 뜻한다.
- 여러 서버에 트래픽을 고르게 분배하는 역할을 담당하는 `로드 밸런서`가 필요하다.
  - 사용자는 로드 밸런서의 공개 IP로 접속하고, 보안을 위해 로드 밸런서 <-> 다수의 서버 간 통신에는 사설 IP 주소가 이용된다.
- 서버 전체의 다운을 방지할 수 있다.
- 수직적 확장에 비해 상대적으로 확장이 용의하다.

#### 무상태(stateless) 웹 계층
- 웹 서버에 클라이언트의 상태(예를 들면 세션)를 저장하지 않는 웹 계층을 무상태 웹 계층이라 함.
- 수평적 확장을 위해서는 필수적임(그게 아니라면 클라이언트 A - 서버 A 매칭을 강제해야함)
- 이를 위해 상태 정보를 별도의 저장소(예: Redis, DynamoDB)에 보관하여 웹 서버들이 공유할 수 있도록 해야 함.


<br></br>

## 데이터베이스

### 다중화
- 주(master) - 부(slave) 설정을 통해 데이터베이스 다중화를 구현할 수 있다.
- 주 데이터베이스에서는 쓰기 연산만, 부 데이터베이스에서는 읽기 연산만 수행한다.
- 데이터베이스 서버 가운데 하나가 다운되어도 데이터는 보존된다.

### 로드밸런서와 데이터베이스 다중화 적용한 설계
- 사용자는 DNS로부터 로드밸런서의 공개 IP 주소를 받는다.
- 해당 IP 주소를 사용해 로드밸런서에 접속한다.
- HTTP 요청은 서버 1 또는 서버 2로 전달된다.
- 웹 서버는 사용자의 데이터를 부 데이터베이스에서 읽는다.
- 웹 서버는 데이터 변경 연산은 주 데이터베이스로 전달한다.


<br></br>


<br></br>

## 캐시

### 캐시 계층
- 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소다.
- 데이터베이스보다 훨씬 빠르다.

### 캐시 사용시 유의할 점
- 캐시는 어떤 상황에 바람직한가?: 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어나는 경우
- 어떤 데이터를 캐시에 두어야 하는가?: 영속적으로 보관할 데이터를 캐시에 두어서는 안 된다
- 캐시에 보관된 데이터는 어떻게 만료되는가?: 만료 정책을 마련해 두는 것은 좋은 습관이다
- 일관성은 어떻게 유지되는가?: 저장소의 원본을 갱신하는 연산과 캐시를 갱신하는 연산이 단일 트랜잭션으로 처리되지 않는 경우 일관성이 깨질 수 있다
- 장애에는 어떻게 대처할 것인가?: 캐시 서버를 한 대만 두는 경우 해당 서버는 단일 장애 지점이 되어버릴 가능성이 있다
- 캐시 메모리는 얼마나 크게 잡을 것인가?: 캐시 메모리가 너무 작으면 액세스 패턴에 따라서는 데이터가 너무 자주 캐시에서 밀려난다


<br></br>

## 콘텐츠 전송 네트워크(CDN)

### CDN의 동작 방식
- 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크다.
- 이미지, 비디오, CSS, JavaScript 파일 등을 캐시할 수 있다.

### CDN 사용시 고려사항
- 비용: CDN은 보통 제3사업자에 의해 운영되며, 데이터 전송 양에 따라 요금을 낸다
- 적절한 만료 시한 설정: 시의성이 중요한 콘텐츠의 경우 만료 시점을 잘 정해야 한다
- CDN 장애에 대한 대처 방안: CDN 자체가 죽었을 때 웹사이트/애플리케이션이 어떻게 동작해야 하는지 고려해야 한다
- 콘텐츠 무효화: 아직 만료되지 않은 콘텐츠라 하더라도 아래 방법 중 하나를 쓰면 CDN에서 제거할 수 있다


<br></br>


<br></br>

## 무상태 웹 계층

### 상태 정보 의존적인 아키텍처
- 클라이언트가 같은 서버로 요청을 보내야 한다는 문제가 있다.
- 로드밸런서가 끈끈한 세션이라는 기능을 제공하기는 하지만 로드밸런서에 부담을 주고, 뒷단에 서버를 추가하거나 제거하기도 까다롭게 만든다.

### 무상태 아키텍처
- 사용자로부터의 HTTP 요청은 어떤 웹 서버로도 전달될 수 있다.
- 웹 서버는 상태 정보가 필요할 때 공유 저장소로부터 데이터를 가져온다.
- 상태 정보는 웹 서버로부터 물리적으로 분리되어 있다.


<br></br>

## 데이터 센터

### 지리적 라우팅
- 사용자는 가장 가까운 데이터 센터로 안내된다.
- 이 절차를 지리적 라우팅(geoDNS-routing 또는 geo-routing)이라 한다.

### 다중 데이터센터 아키텍처를 만들 때 해결해야 할 기술적 난제
- 트래픽 우회: 올바른 데이터센터로 트래픽을 보내는 효과적인 방법을 찾아야 한다
- 데이터 동기화: 데이터센터마다 별도의 데이터베이스를 사용하고 있는 상황이라면, 장애가 자동으로 복구되어 트래픽이 다른 데이터베이스로 우회된다 해도 해당 데이터센터에는 찾는 데이터가 없을 수 있다
- 테스트와 배포: 여러 데이터센터를 사용하도록 시스템이 구성된 상황에서는 웹 사이트 또는 애플리케이션을 여러 위치에서 테스트해보는 것이 중요하다



<br></br>

## 메시지 큐

### 메시지 큐의 장점
- 메시지 큐는 메시지의 무손실을 보장하는, 비동기 통신을 지원하는 컴포넌트다.
- 메시지의 버퍼 역할을 하며, 비동기적으로 전송한다.

### 메시지 큐의 아키텍처
- 입력 서비스라고 불리는 생산자 또는 발행자가 메시지를 만들어 메시지 큐에 발행한다.
- 큐에는 보통 소비자 혹은 구독자라 불리는 서비스 혹은 서버가 연결되어 있는데 메시지를 받아 그에 맞는 동작을 수행한다.


<br></br>

## 로그, 메트릭 그리고 자동화

### 로그
- 에러 로그를 모니터링하는 것은 중요하다.
- 서버 단위로 로그를 모니터링할 수도 있지만, 로그를 단일 서비스로 모아주는 도구를 활용하면 더 편리하게 검색하고 조회할 수 있다.

### 메트릭
- 메트릭을 잘 수집하면 사업 현황에 관한 유용한 정보를 얻을 수도 있고, 시스템의 현재 상태를 손쉽게 파악할 수도 있다.
- 호스트 단위 메트릭: CPU, 메모리, 디스크 I/O에 관한 메트릭
- 종합 메트릭: 데이터베이스 계층의 성능, 캐시 계층의 성능
- 핵심 비즈니스 메트릭: 일별 능동 사용자, 수익, 재방문

### 자동화
- 시스템이 크고 복잡해질수록 생산성을 높이기 위해 자동화 도구를 활용해야 한다.
- 지속적 통합을 도와주는 도구를 활용하면 개발자가 만든 코드가 어떤 문제가 없는지 자동으로 확인해줄 수 있어 개발 생산성을 크게 향상시킬 수 있다.


<br></br>

## 데이터베이스의 규모 확장

### 수직적 확장
- 스케일 업이라고도 한다.
- 기존 서버에 더 많은 또는 고성능의 자원을 증설하는 방법이다.

### 수평적 확장
- 샤딩이라고도 한다.
- 대규모 데이터베이스를 샤드라고 부르는 작은 단위로 분할하는 기법이다.
- 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없다.

### 샤딩 전략
- 샤딩 키를 어떻게 정하느냐에 따라 데이터가 샤드들에 어떻게 분산될지가 정해진다.
- 샤딩 키는 파티션 키라고도 부른다.
- 샤딩 키를 정할 때는 데이터를 고르게 분할할 수 있도록 하는 것이 가장 중요하다.


### 샤딩 도입 시 해결해야 할 문제들
- 데이터의 재 샤딩: 데이터가 너무 많아져서 하나의 샤드로는 더 이상 감당하기 어려울 때
- 유명인사 문제: 핫스팟 키 문제라고도 한다. 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제
- 조인과 비정규화: 하나의 데이터베이스를 여러 샤드 서버로 쪼개고 나면, 여러 샤드에 걸친 데이터를 조인하기가 힘들어진다


<br></br>

## 백만 사용자, 그리고 그 너머

시스템의 규모를 확장하는 것은 지속적이고 반복적인 과정이다. 이 장에서 다룬 기법들을 정리해보면:

- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 한 많은 데이터를 캐시할 것
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스할 것
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
- 각 계층은 독립적 서비스로 분할할 것
- 시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것